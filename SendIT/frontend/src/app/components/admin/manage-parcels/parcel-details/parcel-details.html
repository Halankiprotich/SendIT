<div class="admin-container">
  <!-- Shared Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <div class="content-header">
      <div class="header-left">
        <h1>Parcel Details</h1>
      </div>
      <div class="header-right">
        <button class="btn-back-to-parcels" (click)="goBack()">
          <i class="fas fa-arrow-left"></i>
          Back to Parcels
        </button>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-container">
        <div class="loading-spinner">Loading parcel details...</div>
      </div>

      <!-- Parcel Details -->
      <div *ngIf="!loading && parcel" class="parcel-details">
        <!-- Order Information -->
        <div class="section" style="animation-delay: 0.1s;">
          <h2 class="section-title">Order Information</h2>
          <div class="info-grid">
            <div class="info-item">
              <label>Tracking Number:</label>
              <span>{{ parcel.trackingNumber }}</span>
            </div>
            <div class="info-item">
              <label>Status:</label>
              <span class="status-badge" [ngClass]="getStatusClass(parcel.status)">
                {{ parcel.status }}
              </span>
            </div>
            <div class="info-item">
              <label>Pickup Date:</label>
              <span>{{ parcel.pickupDate }}</span>
            </div>
            <div class="info-item">
              <label>Delivery Date:</label>
              <span>{{ parcel.deliveryDate }}</span>
            </div>
            <div class="info-item">
              <label>Weight:</label>
              <span>{{ parcel.weight }}</span>
            </div>
            <div class="info-item">
              <label>Dimensions:</label>
              <span>{{ parcel.dimensions }}</span>
            </div>
            <div class="info-item">
              <label>Price:</label>
              <span class="price-value">{{ parcel.price }}</span>
            </div>
          </div>
        </div>

        <!-- Sender Information -->
        <div class="section" style="animation-delay: 0.2s;">
          <h2 class="section-title">Sender Information</h2>
          <div class="contact-info">
            <div class="info-item">
              <label>Name:</label>
              <span>{{ parcel.sender.name }}</span>
            </div>
            <div class="info-item">
              <label>Address:</label>
              <span>{{ parcel.sender.address }}</span>
            </div>
            <div class="info-item">
              <label>Contact Number:</label>
              <span>{{ parcel.sender.phone }}</span>
            </div>
            <div class="info-item">
              <label>Email:</label>
              <span>{{ parcel.sender.email }}</span>
            </div>
          </div>
        </div>

        <!-- Receiver Information -->
        <div class="section" style="animation-delay: 0.3s;">
          <h2 class="section-title">Receiver Information</h2>
          <div class="contact-info">
            <div class="info-item">
              <label>Name:</label>
              <span>{{ parcel.receiver.name }}</span>
            </div>
            <div class="info-item">
              <label>Address:</label>
              <span>{{ parcel.receiver.address }}</span>
            </div>
            <div class="info-item">
              <label>Contact Number:</label>
              <span>{{ parcel.receiver.phone }}</span>
            </div>
            <div class="info-item">
              <label>Email:</label>
              <span>{{ parcel.receiver.email }}</span>
            </div>
          </div>
        </div>

        <!-- Driver Information -->
        <div class="section" *ngIf="parcel.driver && parcel.status !== 'Delivered' && parcel.status !== 'Completed'" style="animation-delay: 0.4s;">
          <div class="section-header">
            <h2 class="section-title">Assigned Driver</h2>
            <button class="btn-reassign-driver" (click)="reassignDriver()">
              <i class="fas fa-exchange-alt"></i>
              Reassign Driver
            </button>
          </div>
          <div class="driver-info">
            <div class="driver-header">
              <div class="driver-avatar">
                <img 
                  *ngIf="parcel.driver?.profilePicture && parcel.driver.profilePicture !== ''" 
                  [src]="parcel.driver.profilePicture" 
                  [alt]="parcel.driver.name"
                  class="driver-profile-image"
                  (error)="onDriverImageError($event)"
                />
                <i *ngIf="!parcel.driver?.profilePicture || parcel.driver.profilePicture === ''" class="fas fa-user"></i>
              </div>
              <div class="driver-name-title">
                <h3>{{ parcel.driver.name }}</h3>
                <span class="driver-status">Active Driver</span>
              </div>
            </div>
            <div class="driver-details">
              <div class="info-item">
                <label>Phone:</label>
                <span>{{ parcel.driver.phone }}</span>
              </div>
              <div class="info-item">
                <label>Email:</label>
                <span>{{ parcel.driver.email }}</span>
              </div>
              <div class="info-item">
                <label>Vehicle Number:</label>
                <span>{{ parcel.driver.vehicleNumber }}</span>
              </div>
              <div class="info-item">
                <label>License Number:</label>
                <span>{{ parcel.driver.licenseNumber }}</span>
              </div>
            </div>
          </div>
        </div>



        <!-- No Driver Assigned -->
        <div class="section" *ngIf="!parcel.driver" style="animation-delay: 0.4s;">
          <h2 class="section-title">Driver Assignment</h2>
          <div class="no-driver">
            <div class="no-driver-icon">
              <i class="fas fa-user-slash"></i>
            </div>
            <div class="no-driver-content">
              <h3>No Driver Assigned</h3>
              <p>This parcel has not been assigned to a driver yet.</p>
              <button class="btn-assign-driver" (click)="assignDriver()">
                <i class="fas fa-plus"></i>
                Assign Driver
              </button>
            </div>
          </div>
        </div>

        <!-- Order History -->
        <div class="section" style="animation-delay: 0.5s;">
          <h2 class="section-title">Order History</h2>
          <div class="history-list">
            <div *ngFor="let item of parcel.orderHistory; let i = index" class="history-item">
              <div class="history-timeline">
                <div class="timeline-line" [class.active]="i === 0" [class.completed]="item.status === 'Completed'"></div>
                <div class="history-icon" [class.active]="i === 0" [class.completed]="item.status === 'Completed'">
                  <i [class]="item.icon"></i>
                </div>
              </div>
              <div class="history-content">
                <div class="history-status">{{ item.status }}</div>
                <div class="history-time">{{ item.date }}, {{ item.time }}</div>
                <div class="history-location" *ngIf="item.location">{{ item.location }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Parcel Location (Map) -->
        <div class="section" style="animation-delay: 0.6s;">
          <div class="map-header">
            <h2 class="section-title">Parcel Location</h2>
            <div class="map-controls">
              <button class="btn-secondary" (click)="toggleMapView()">
                <i class="fas fa-eye"></i>
                {{ showMapView ? 'Hide Map' : 'Show Map' }}
              </button>
              <button class="btn-secondary" (click)="fitMapToMarkers()" *ngIf="showMapView">
                <i class="fas fa-expand-arrows-alt"></i>
                Fit to Route
              </button>
              <button class="btn-secondary" (click)="refreshMapMarkers()" *ngIf="showMapView">
                <i class="fas fa-sync-alt"></i>
                Refresh
              </button>
            </div>
          </div>
          
          <!-- Map View -->
          <div class="map-container" *ngIf="showMapView">
            <app-map
              #mapComponent
              [height]="'400px'"
              [markers]="mapMarkers"
              [markerTypes]="mapMarkerTypes"
              [center]="mapCenter"
              [showRoute]="mapMarkers.length >= 2"
              [zoom]="mapMarkers.length > 1 ? 11 : 13"
              [showControls]="true"
              (mapReady)="onMapReady($event)"
              (markerClick)="onMarkerClick($event)"
              (mapClick)="onMapClick($event)"
              (mapErrorEvent)="onMapError($event)"
              (routeUpdated)="onRouteUpdated($event)">
            </app-map>
            
            <!-- Map Legend -->
            <div class="map-overlay">
              <div class="map-legend">
                <div class="legend-item">
                  <div class="legend-pin pickup"></div>
                  <span>Pickup Location</span>
                </div>
                <div class="legend-item">
                  <div class="legend-pin delivery"></div>
                  <span>Delivery Location</span>
                </div>
                <div class="legend-item" *ngIf="parcel?.driver && parcel?.status === 'In Transit'">
                  <div class="legend-pin driver"></div>
                  <span>Driver Location</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Tracking Info (when map is hidden) -->
          <div class="tracking-info-section" *ngIf="!showMapView">
            <div class="tracking-info">
              <div class="tracking-header">
                <h3><i class="fas fa-route"></i> Route Information</h3>
              </div>
              
              <!-- Route Details -->
              <div class="route-details">
                <div class="route-point pickup">
                  <div class="point-icon">
                    <i class="fas fa-map-marker-alt"></i>
                  </div>
                  <div class="point-info">
                    <h4>Pickup Location</h4>
                    <p>{{ parcel.sender.address || 'Address not available' }}</p>
                  </div>
                </div>
                
                <div class="route-line">
                  <div class="line-segment"></div>
                  <div class="route-stats">
                    <span class="distance">{{ routeDistance || 'Calculating...' }} km</span>
                    <span class="duration">{{ routeDuration || 'Calculating...' }}</span>
                  </div>
                </div>
                
                <div class="route-point delivery">
                  <div class="point-icon">
                    <i class="fas fa-flag-checkered"></i>
                  </div>
                  <div class="point-info">
                    <h4>Delivery Location</h4>
                    <p>{{ parcel.receiver.address || 'Address not available' }}</p>
                  </div>
                </div>
                
                <!-- Driver Location (when in transit) -->
                <div class="route-point driver" *ngIf="parcel.driver && parcel.status === 'In Transit'">
                  <div class="point-icon">
                    <i class="fas fa-user"></i>
                  </div>
                                  <div class="point-info">
                  <h4>Driver Location</h4>
                  <p>{{ parcel.driver.name || 'Unknown' }} - {{ parcel.driver.vehicleNumber || 'N/A' }}</p>
                </div>
                </div>
              </div>
              
              <!-- Current Status -->
              <div class="current-status">
                <h3><i class="fas fa-info-circle"></i> Current Status</h3>
                <div class="status-details">
                  <div class="status-item">
                    <label>Current Location:</label>
                    <span>{{ parcel.currentLocation || 'Pending pickup' }}</span>
                  </div>
                  <div class="status-item">
                    <label>Estimated Delivery:</label>
                    <span>{{ parcel.estimatedTime }}</span>
                  </div>
                                      <div class="status-item" *ngIf="parcel.driver">
                      <label>Driver:</label>
                      <span>{{ parcel.driver.name || 'Unknown' }} ({{ parcel.driver.vehicleNumber || 'N/A' }})</span>
                    </div>
                  <div class="status-item" *ngIf="parcel.driver?.phone">
                    <label>Driver Contact:</label>
                    <span>{{ parcel.driver?.phone }}</span>
                  </div>
                  <div class="status-item" *ngIf="parcel.driver && parcel.status === 'In Transit'">
                    <label>Driver Location:</label>
                    <span>Active - Following route</span>
                  </div>
                </div>
              </div>
              
              <!-- Progress Bar -->
              <div class="delivery-progress">
                <h3><i class="fas fa-chart-line"></i> Delivery Progress</h3>
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getDeliveryProgress()"></div>
                  </div>
                  <div class="progress-labels">
                    <span>Order Placed</span>
                    <span>In Transit</span>
                    <span>Delivered</span>
                  </div>
                </div>
              </div>
              
              <!-- Quick Actions -->
              <div class="quick-actions">
                <button class="action-btn" (click)="toggleMapView()">
                  <i class="fas fa-map"></i>
                  Show Map
                </button>
                <button class="action-btn" (click)="refreshMapMarkers()">
                  <i class="fas fa-sync-alt"></i>
                  Refresh
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div> 